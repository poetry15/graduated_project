<!DOCTYPE html>
<html>

  <head>
    <title>心情地圖</title>
    <meta charset="utf-8" name="viewport"
      content="width=device-width, initial-scale=3">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css"
      rel="stylesheet">
    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="../config.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/vconsole@3.2.0/dist/vconsole.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
    var vConsole = new VConsole();
  </script>
    <style>
    .grid-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      width: 300px;
      height: 300px;
      gap: 0px;
    }
    .grid-item {
      display: flex;
      align-items: center;
      justify-content: center;
      /*background-color: lightblue;
      border: 1px solid black;*/
      height: 100%;
      width: 100%;
    }
   
    /* 頂部行 */
    .item-1 {
      grid-column: 1;
      grid-row: 1;
    }

    .item-2 {
      grid-column: 2;
      grid-row: 1;
    }

    .item-3 {
      grid-column: 3;
      grid-row: 1;
    }

    .item-4 {
      grid-column: 4;
      grid-row: 1;
    }

    .item-5 {
      grid-column: 4;
      grid-row: 2;
    }

    /* 右側列 */
    .item-6 {
      grid-column: 4;
      grid-row: 3;
    }

    .item-7 {
      grid-column: 4;
      grid-row: 4;
    }

    .item-8 {
      grid-column: 3;
      grid-row: 4;
    }

    /* 底部行 */
    .item-9 {
      grid-column: 2;
      grid-row: 4;
    }

    .item-10 {
      grid-column: 1;
      grid-row: 4;
    }

    .item-11 {
      grid-column: 1;
      grid-row: 3;
    }

    .item-12 {
      grid-column: 1;
      grid-row: 2;
    }

    /* 中間區域 */
    .middle {
      grid-row: 2 / span 2;
      grid-column: 2 / span 2;
      /*grid-column: 1 / span 4;
      grid-row: 1 / span 4;*/
      background-color: white;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
    }
    .middle-item {
      height: 100%;
      width: 100%;
      border: 1px solid black;
    }
  </style>
  </head>
  <body>
    <div id="games-container" class="container mt-4" style="transform: scale(3); transform-origin: top left"></div>
    <canvas id="canvas"></canvas>
    <script>
    function captureImage(ID) {
      const container = document.getElementById(ID);
      const middleDiv = container.querySelector('.middle');
      if (middleDiv) {
        return html2canvas(middleDiv, { scale: 5 }).then(canvas => {
          return canvas.toDataURL('image/png'); // 在 Promise resolve 中返回 imgData
        });
      } else {
        return Promise.reject("Element not found"); // 如果元素不存在，返回拒絕的 Promise
      }
    }
  </script>
    <script>
    const color = ["rgb(106, 76, 147)", "rgb(25, 130, 196)", "rgb(138, 201, 38)", "rgb(255, 202, 58)", "rgb(255, 89, 94)"];
    let put_color = {};
    let roundsData = {};
    let socket;
    let point = 0;
    let MoodColor = 0;
    let imgindex = 0;
    let userID = '2312312';

    async function FetchData() {
      try {
        const response = await fetch(url+'/moodmap?UserID='+ userID, {
          method: 'GET',
          headers: {
            'ngrok-skip-browser-warning': 'true'
          }
        });
        const result = await response.json();
        console.log(result)
        if (result.length > 0) 
          return JSON.parse(result);
        else
          return [];
      } catch (error) {
        console.error('Error fetching data:', error);
        return [];
      }
    }

    function initializeWebSocket() {
      socket = io(url, { transports: ['websocket'] });
      socket.on('connect', () => {
        console.log('Connected to server');
      });
      socket.on ('message', async(event) => {
        const data = event;
        console.log(data);
        if (data.action == 'updateMap') {
          data.map.forEach((item) => {
            const container = document.getElementById(data.roundID);
            const gridItem = container.getElementById(item.id);
            gridItem.style.backgroundColor = color[item.color-1];
          });
        }
        if(data.action == 'finish') {
          let img_data = await captureImage(data.roundID);
          socket.emit('message',{action:'finish','img': img_data});
        }
        if (data.action == 'deleteData') {
          const container = document.getElementById(data.roundID);
          container.remove();
          delete roundsData[data.roundID];
        }
        if (data.action == 'generateImage') {
          roundsData[data.roundID].images.push(data.image);
          displayMap(data.roundID);
        }
      });
    }

    async function initMap() {
      const response = await fetch(url+'/map', {
        method: 'GET',
        headers: {
          'ngrok-skip-browser-warning': 'true'
        },
      });

      const data = await response.json();
      console.log(data);
      let index = 0;
      data.map.forEach((mapInfo) => {
        const roundID = mapInfo._id;
        if ( !roundsData[roundID] ) {
          roundsData[roundID] = {
            map: mapInfo.map,
            images: []
          };
          createGridContainer(roundID);
        }
        else {
          roundsData[roundID].map = mapInfo.map;
        }
      });
      data.image.forEach((imageInfo) => {
        const roundID = imageInfo.roundID;
        if ( !roundsData[roundID] ) {
          roundsData[roundID] = {
            map: [],
            images: [imageInfo.image]
          };
        }
        else {
          roundsData[roundID].images.push(imageInfo.image);
        }
      });
    }

    async function displayMap(ID) {
      info = roundsData[ID];
      const gridContainer = document.getElementById(ID);
      if (info) {
        info.map.forEach((value,index) => {
          const gridItem = gridContainer.getElementById(String(index+1));
          if (gridItem)
            gridItem.style.backgroundColor = color[value-1];
        });
        info.images.forEach((imgurl) => {
          const gridItem = gridContainer.getElementById("item"+String(((imgindex++)%12+1)));
            const img = document.createElement('img');
            img.src = imgurl;
            img.id = 'img'
            img.style.width = "100%";
            img.style.height = "100%";
            gridItem.appendChild(img);
        });
      }
    }

    function createGridContainer(roundID) {
      // 創建包含 grid-items 的主容器
      const gameContainer = document.createElement('div');
      gameContainer.className = 'grid-container';
      gameContainer.id = roundID;  // 使用 roundID 來唯一標識每個遊戲
    
      // 創建外圍的 12 個 grid-item
      for (let i = 1; i <= 12; i++) {
        const item = document.createElement('div');
        item.className = `grid-item item-${i}`;
        item.id = `item${i}`;
        gameContainer.appendChild(item);
      }
    
      // 創建中心的 middle 區域
      const middleContainer = document.createElement('div');
      middleContainer.className = 'grid-item middle';
    
      // 創建中間的 64 個 grid-item
      for (let i = 1; i <= 64; i++) {
        const middleItem = document.createElement('div');
        middleItem.className = 'middle-item';
        middleItem.id = i;
        middleContainer.appendChild(middleItem);
      }
      gameContainer.appendChild(middleContainer);
      document.getElementById('games-container').appendChild(gameContainer);
    }

    document.addEventListener('DOMContentLoaded', async() => {
      await initMap();
      await InitializePage();
      for (const roundID in roundsData) {
        displayMap(roundID);
      }
      initializeWebSocket();
    });
  </script>
  </body>

</html>
